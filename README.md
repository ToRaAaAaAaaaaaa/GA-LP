# クリスマスツリー2次元パッキング問題 - GA + Bottom-Left戦略

for i in {1..50}; do uv run python main.py --n $i --angle-step 5 --grid-step 0.005 --population 20 --generations 10; done

## 概要

このプログラムは、複数のクリスマスツリーを正方形のコンテナ内に効率的に配置する2次元パッキング問題を解決するためのソルバーです。遺伝的アルゴリズム（GA）とBottom-Left戦略を組み合わせて、コンテナの面積を最小化する配置を探索します。

## 主な機能

### 1. クリスマスツリーの定義（`ChristmasTree`クラス）

- **形状**: 3段のツリー本体（段階的に細くなる）と幹を持つポリゴン
- **パラメータ**: 幹の幅・高さ、各段の幅、高さなど
- **操作**: 回転・平行移動に対応
- **高精度**: Decimal型とスケーリング（1e15倍）により数値誤差を最小化
- **衝突判定**: Shapelyライブラリを使用した高速な重なり判定

### 2. Bottom-Left配置戦略（`ImprovedBottomLeftPacker`クラス）

Bottom-Left戦略は、ツリーを左下に詰めて配置する古典的なヒューリスティック手法です。

**配置アルゴリズム**:

1. 最初のツリーを左下隅(0,0)に配置
2. 2番目以降のツリーは以下の手順で配置:
   - グリッド探索により全ての候補位置をチェック
   - 既存のツリーと重ならない位置を探索
   - 原点(0,0)からの距離 `sqrt(x² + y²)` を最小化する位置を選択
   - わずかにy座標を優先（より下に配置）

**特徴**:

- グリッドベース探索（デフォルト: 0.02刻み）
- 探索範囲の制限により高速化
- 衝突判定の高速化（Shapelyのprepared geometry使用）

### 3. 遺伝的アルゴリズム（`ImprovedGeneticAlgorithm`クラス）

ツリーの配置順序と回転角度を最適化します。

**個体の遺伝子型**:

- `sequence`: ツリーの配置順序（順列）
- `angles`: 各ツリーの回転角度（0-359度、指定刻み）

**適応度関数**:

```python
fitness = impact_factor / (container_size² + ε)
```

- コンテナの面積が小さいほど適応度が高い
- 正方形制約: `container_size = max(width, height)`

**遺伝的操作**:

- **選択**: エリート保存 + ルーレット選択
- **交叉**:
  - 配置順序: 順序交叉（Order Crossover, OX）
  - 回転角度: 一点交叉
- **突然変異**:
  - 配置順序: 逆位変異（部分配列の反転）
  - 回転角度: ランダムな角度への変更

**進化プロセス**:

1. 初期集団をランダム生成
2. 全個体の適応度を評価（Bottom-Leftパッキングを実行）
3. 指定世代数まで繰り返し:
   - 選択
   - 交叉
   - 突然変異
   - 評価
   - 最良解の更新

## 使用方法

### 基本実行

```bash
python main.py
```

### オプション指定

```bash
python main.py \
  --n 20 \
  --angle-step 10 \
  --population 100 \
  --generations 50 \
  --grid-step 0.01 \
  --mutation-rate 0.2 \
  --elite-ratio 0.15 \
  --output-dir ./results
```

### パラメータ説明

| パラメータ | デフォルト | 説明 |
|-----------|-----------|------|
| `--n` | 10 | 配置するツリーの数 |
| `--angle-step` | 5 | 回転角度の刻み幅（度） |
| `--population` | 50 | GAの個体数 |
| `--generations` | 40 | GAの世代数 |
| `--grid-step` | 0.02 | Bottom-Leftグリッド探索の刻み幅 |
| `--mutation-rate` | 0.15 | 突然変異率（0.0-1.0） |
| `--elite-ratio` | 0.1 | エリート保存率（0.0-1.0） |
| `--output-dir` | ./output_improved | 結果出力ディレクトリ |

## 出力

実行後、指定したディレクトリに以下のファイルが生成されます:

1. **CSVファイル** (`solution_nXX.csv`)
   - 各ツリーの配置情報
   - 列: `id`, `x`, `y`, `deg`（中心座標と回転角度）

2. **可視化画像** (`solution_nXX.png`)
   - ツリーの配置図
   - 赤い破線: 正方形コンテナの境界
   - 緑の多角形: 各ツリー

## 技術的な特徴

### 高精度計算

- `Decimal`型による任意精度演算
- スケーリング係数（1e15）による浮動小数点誤差の回避
- 数値安定性の向上

### 効率的な幾何計算

- Shapelyライブラリによる高速なポリゴン操作
- `prepared_polygon`による衝突判定の高速化
- affinity変換（回転・平行移動）の効率的な実装

### 可視化

- Matplotlibによる配置結果の可視化
- コンテナサイズと面積の表示
- 高解像度画像出力（300 DPI）

## 依存ライブラリ

```txt
numpy
pandas
matplotlib
shapely
tqdm
```

### インストール

```bash
pip install numpy pandas matplotlib shapely tqdm
```

## アルゴリズムの特性

### 時間計算量

- **Bottom-Left配置**: O(n × (W/step) × (H/step))
  - n: ツリー数
  - W, H: 探索範囲の幅・高さ
  - step: グリッドステップ
- **GA全体**: O(generations × population × n × grid_search_cost)

### パラメータチューニングのヒント

**高速化したい場合**:

- `grid-step`を大きく（0.05-0.1）
- `population`を小さく（20-30）
- `generations`を少なく（20-30）

**高品質な解が欲しい場合**:

- `grid-step`を小さく（0.01-0.005）
- `population`を大きく（100-200）
- `generations`を多く（100-200）
- `angle-step`を細かく（1-2度）

**バランス型**（デフォルト設定）:

- ツリー数10-20程度で数分以内に実行可能
- 実用的な品質の解を得られる

## 制約と考慮事項

1. **正方形制約**: コンテナは正方形（幅 = 高さ）
2. **重なり禁止**: ツリー同士は重ならない（接触は許可）
3. **配置領域**: 全てのツリーは第1象限（x ≥ 0, y ≥ 0）に配置
4. **計算時間**: ツリー数が増えると指数的に計算時間が増加

## 応用と拡張

- 他の形状への適用（任意のポリゴン）
- 長方形コンテナへの対応
- 他のパッキング戦略との組み合わせ
- 局所探索法（シミュレーテッドアニーリング等）との併用
- 並列化による高速化

## ライセンス

（プロジェクトに応じて記載）
